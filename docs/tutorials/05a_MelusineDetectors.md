# Melusine Detectors

The `MelusineDetector` component aims at standardizing how detection 
is performed in a `MelusinePipeline`. 

!!! tip
    Project running over several years (such as email automation) 
    may accumulate technical debt over time. Standardizing code practices 
    can limit the technical debt and ease the onboarding of new developers.

The `MelusineDetector` class splits detection into three steps:

- `pre_detect`: Select/combine the inputs needed for detection.
Ex: Select the text parts tagged as `BODY` and combine them with the text 
in the email header.
- `detect`: Use regular expressions, ML models or heuristics to run detection
on the input text.
- `post_detect`: Run detection rules such as thresholding or combine results from multiple models.

The method `transform` is defined by the BaseClass `MelusineDetector` and will call 
the pre_detect/detect/post_detect methods in turn (Template pattern).

```Python
# Instantiate Detector
detector = MyDetector()

# Run pre_detect, detect and post_detect on input data
data_with_detection = detector.transform(data)
```

Here is the full code of a MelusineDetector to detect emails related to viruses. 
The next sections break down the different parts of the code.

```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:detector
--8<--
```

The detector is run on a simple dataframe:
```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:run
--8<--
```

The output is a dataframe with a new `virus_result` column.

|    | body                      | header                | virus_result   |
|---:|:--------------------------|:----------------------|:---------------|
|  0 | This is a dangerous virus | test                  | True           |
|  1 | test                      | test                  | False          |
|  2 | test                      | viruses are dangerous | True           |
|  3 | corona virus is annoying  | test                  | False          |

!!! tip
    Columns that are not declared in the `output_columns` are dropped automatically.


## Detector init
In the init method, you should call the superclass init and provide:

- A name for the detector
- Inputs columns
- Output columns

```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:detector_init
--8<--
```

!!! tip
    If the init method of the super class is enough (parameters `name`, `input_columns` and `output_columns`)
    you may skip the init method entirely when defining your `MelusineDetector`.


## Detector pre_detect
The `pre_detect` method simply combines the header text and the body text
(separated by a line break).
```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:pre_detect
--8<--
```

## Detector detect
The `detect` applies two regexes on the selected text:
- A positive regex to catch mentions to viruses
- A negative regex to avoid false positive detections
```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:detect
--8<--
```

## Detector post_detect
The `post_detect` combines the regex detection result to determine the final result.
```Python
--8<--
docs_src/MelusineDetectors/tutorial001.py:post_detect
--8<--
```

## Are MelusineDetectors mandatory for melusine?
No.  

You can use any scikit-learn compatible component in your `MelusinePipeline`. 
However, we recommend using the `MelusineDetector` (and `MelusineTransformer`) 
classes to benefit from:

- Code standardization
- Input columns validation
- Dataframe backend variabilization
  Today dict and pandas backend are supported but more backends may be added (e.g. polars)
- Debug mode
- Multiprocessing

Check-out the [next tutorial](05a_MelusineDetectors.md){target=_blank} 
to discover advanced features of the `MelusineDetector` class.